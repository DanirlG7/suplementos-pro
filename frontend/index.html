<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Suplementos Pro</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
  <style>
    body { background: #f8f9fa; font-family: 'Segoe UI', sans-serif; }
    .product-card { transition: 0.3s; }
    .product-card:hover { transform: scale(1.05); box-shadow: 0 8px 16px rgba(0,0,0,0.2); }
    .cart-badge { font-size: 0.7rem; }
    .modal-header { background: #0d6efd; color: white; }
    .btn-primary { background: #0d6efd; border: none; }
    .btn-success { background: #198754; }
    .btn-warning { background: #ffc107; color: #212529; }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container">
      <a class="navbar-brand fw-bold" href="#">Suplementos Pro</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto align-items-center">
          <li class="nav-item">
            <button id="loginBtn" class="btn btn-outline-light me-2" data-bs-toggle="modal" data-bs-target="#authModal">Login</button>
          </li>
          <li class="nav-item">
            <button id="cartBtn" class="btn btn-outline-light position-relative" data-bs-toggle="modal" data-bs-target="#cartModal">
              <i class="fas fa-shopping-cart"></i>
              <span id="cartCount" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger cart-badge">0</span>
            </button>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="container my-5">
    <div class="row" id="productsRow">
      <!-- Produtos carregados via JS -->
    </div>
  </div>

  <!-- MODAL AUTENTICAÇÃO -->
  <div class="modal fade" id="authModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="authTitle">Login</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="authForm">
            <div id="registerFields" class="d-none">
              <div class="mb-3">
                <label class="form-label">Nome Completo</label>
                <input type="text" class="form-control" id="fullName" required />
              </div>
              <div class="mb-3">
                <label class="form-label">Email</label>
                <input type="email" class="form-control" id="email" required />
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label">Usuário</label>
              <input type="text" class="form-control" id="username" required />
            </div>
            <div class="mb-3">
              <label class="form-label">Senha</label>
              <input type="password" class="form-control" id="password" required />
            </div>
            <button type="submit" class="btn btn-primary w-100" id="authSubmit">Entrar</button>
          </form>
          <div class="text-center mt-3">
            <small id="toggleText">Não tem conta? <a href="#" id="toggleLink">Cadastre-se</a></small>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL CARRINHO -->
  <div class="modal fade" id="cartModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Seu Carrinho</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="cartItems">
          <!-- Itens carregados via JS -->
        </div>
        <div class="modal-footer d-flex justify-content-between">
          <h5>Total: R$ <span id="cartTotal">0.00</span></h5>
          <button id="checkoutBtn" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#checkoutModal">Finalizar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL CHECKOUT -->
  <div class="modal fade" id="checkoutModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-success text-white">
          <h5 class="modal-title">Finalizar Pedido</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="checkoutForm">
            <div class="mb-3">
              <label class="form-label">Endereço de Entrega</label>
              <textarea class="form-control" id="address" rows="3" required></textarea>
            </div>
            <div class="mb-3">
              <label class="form-label">Método de Pagamento</label>
              <select class="form-select" id="payment">
                <option value="credit_card">Cartão de Crédito</option>
                <option value="boleto">Boleto</option>
                <option value="pix">PIX</option>
              </select>
            </div>
            <button type="submit" class="btn btn-success w-100">Confirmar Pedido</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const API_URL = 'http://localhost:8000';
    let token = localStorage.getItem('token') || '';
    let isRegister = false;

    // Elementos
    const loginBtn = document.getElementById('loginBtn');
    const authTitle = document.getElementById('authTitle');
    const authSubmit = document.getElementById('authSubmit');
    const toggleLink = document.getElementById('toggleLink');
    const toggleText = document.getElementById('toggleText');
    const registerFields = document.getElementById('registerFields');
    const cartCount = document.getElementById('cartCount');

    // Alternar Login/Cadastro
    toggleLink.onclick = (e) => {
      e.preventDefault();
      isRegister = !isRegister;
      authTitle.textContent = isRegister ? 'Cadastro' : 'Login';
      authSubmit.textContent = isRegister ? 'Cadastrar' : 'Entrar';
      toggleText.innerHTML = isRegister 
        ? 'Já tem conta? <a href="#" id="toggleLink">Faça login</a>' 
        : 'Não tem conta? <a href="#" id="toggleLink">Cadastre-se</a>';
      registerFields.classList.toggle('d-none');
      document.getElementById('toggleLink').onclick = toggleLink.onclick;
    };

    // Autenticação
    document.getElementById('authForm').onsubmit = async (e) => {
      e.preventDefault();
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      const payload = isRegister 
        ? { username, password, email: document.getElementById('email').value, full_name: document.getElementById('fullName').value }
        : { username, password };

      const endpoint = isRegister ? '/auth/register' : '/auth/login';
      try {
        const res = await fetch(API_URL + endpoint, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (res.ok) {
          token = data.access_token;
          localStorage.setItem('token', token);
          bootstrap.Modal.getInstance(document.getElementById('authModal')).hide();
          loginBtn.textContent = `Olá, ${username}`;
          loginBtn.disabled = true;
          loadProducts();
          updateCartCount();
        } else {
          alert(data.detail || 'Erro');
        }
      } catch (err) {
        alert('Erro de conexão');
      }
    };

    // Carregar Produtos
    async function loadProducts() {
      const res = await fetch(API_URL + '/products');
      const products = await res.json();
      const row = document.getElementById('productsRow');
      row.innerHTML = products.map(p => `
        <div class="col-md-4 mb-4">
          <div class="card product-card h-100">
            <img src="${p.image_url}" class="card-img-top" style="height: 200px; object-fit: cover;">
            <div class="card-body d-flex flex-column">
              <h5 class="card-title">${p.name}</h5>
              <p class="card-text flex-grow-1">${p.description}</p>
              <p class="h4 text-success">R$ ${p.price.toFixed(2)}</p>
              <button class="btn btn-primary mt-auto" onclick="addToCart(${p.id})">
                <i class="fas fa-cart-plus"></i> Adicionar
              </button>
            </div>
          </div>
        </div>
      `).join('');
    }

    // Adicionar ao Carrinho
    window.addToCart = async (productId) => {
      if (!token) return alert('Faça login primeiro');
      await fetch(API_URL + '/cart/add', {
        method: 'POST',
        headers: { 
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ product_id: productId })
      });
      updateCartCount();
      alert('Adicionado ao carrinho!');
    };

    // Atualizar Contador
    async function updateCartCount() {
      if (!token) return;
      const res = await fetch(API_URL + '/cart', {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      const data = await res.json();
      cartCount.textContent = data.items.length;
    }

    // Carregar Carrinho
    document.getElementById('cartBtn').onclick = async () => {
      if (!token) return;
      const res = await fetch(API_URL + '/cart', {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      const data = await res.json();
      const items = document.getElementById('cartItems');
      const total = document.getElementById('cartTotal');
      items.innerHTML = data.items.length ? data.items.map(i => `
        <div class="d-flex justify-content-between align-items-center border-bottom py-2">
          <div>
            <strong>${i.name}</strong> x${i.quantity}
          </div>
          <div>R$ ${i.subtotal.toFixed(2)}</div>
        </div>
      `).join('') : '<p class="text-center">Carrinho vazio</p>';
      total.textContent = data.total.toFixed(2);
    };

    // Checkout
    document.getElementById('checkoutForm').onsubmit = async (e) => {
      e.preventDefault();
      const address = document.getElementById('address').value;
      const payment = document.getElementById('payment').value;
      const res = await fetch(API_URL + '/checkout', {
        method: 'POST',
        headers: { 
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ shipping_address: address, payment_method: payment })
      });
      const data = await res.json();
      if (res.ok) {
        alert(`Pedido #${data.order_id} realizado com sucesso!`);
        bootstrap.Modal.getInstance(document.getElementById('checkoutModal')).hide();
        bootstrap.Modal.getInstance(document.getElementById('cartModal')).hide();
        updateCartCount();
      } else {
        alert(data.detail);
      }
    };

    // Inicialização
    if (token) {
      loginBtn.textContent = 'Carregando...';
      loginBtn.disabled = true;
      fetch(API_URL + '/products').then(() => {
        loadProducts();
        updateCartCount();
      });
    } else {
      loadProducts();
    }
  </script>
</body>
</html>